<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>sequential.seq2pat &mdash; Seq2Pat  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Seq2Pat
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../quick.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Usage Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">Seq2Pat Public API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Seq2Pat</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">sequential.seq2pat</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for sequential.seq2pat</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># SPDX-License-Identifier: GPL-2.0</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NamedTuple</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">NoReturn</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Queue</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>

<span class="kn">from</span> <span class="nn">sequential.backend</span> <span class="kn">import</span> <span class="n">seq_to_pat</span> <span class="k">as</span> <span class="n">stp</span>
<span class="kn">from</span> <span class="nn">sequential.utils</span> <span class="kn">import</span> <span class="n">Num</span><span class="p">,</span> <span class="n">check_true</span><span class="p">,</span> <span class="n">get_max_column_size</span><span class="p">,</span> \
    <span class="n">get_min_value</span><span class="p">,</span> <span class="n">get_max_value</span><span class="p">,</span> <span class="n">sort_pattern</span><span class="p">,</span> <span class="n">item_map</span><span class="p">,</span> \
    <span class="n">string_to_int</span><span class="p">,</span> <span class="n">int_to_string</span><span class="p">,</span> <span class="n">check_sequence_feature_same_length</span><span class="p">,</span> \
    <span class="n">validate_attribute_values</span><span class="p">,</span> <span class="n">validate_sequences</span><span class="p">,</span> <span class="n">validate_max_span</span><span class="p">,</span> \
    <span class="n">aggregate_patterns</span><span class="p">,</span> <span class="n">validate_min_frequency</span><span class="p">,</span> <span class="n">validate_batch_args</span><span class="p">,</span> <span class="n">update_min_frequency</span>


<span class="c1"># IMPORTANT: Constant values should not be changed</span>
<span class="c1"># These represent parameters in C++ backend that need to be set by matching exact names</span>
<span class="k">class</span> <span class="nc">_Constants</span><span class="p">:</span>
    <span class="c1"># List where values correspond to the value of upper gap constraints on an attribute, and</span>
    <span class="c1"># whose id can be found in ugapi at the same index</span>
    <span class="n">ugap</span> <span class="o">=</span> <span class="s1">&#39;ugap&#39;</span>

    <span class="c1"># List where values are attribute ids of attributes that have upper gap constraints, and</span>
    <span class="c1"># where the value of the constraint can be found in ugap at the same index</span>
    <span class="n">ugapi</span> <span class="o">=</span> <span class="s1">&#39;ugapi&#39;</span>

    <span class="c1"># List where values correspond to the value of lower gap constraints on an attribute, and</span>
    <span class="c1"># whose id can be found in lgapi at the same index</span>
    <span class="n">lgap</span> <span class="o">=</span> <span class="s1">&#39;lgap&#39;</span>

    <span class="c1"># List where values values are attribute ids of attributes that have lower gap constraints, and</span>
    <span class="c1"># where the value of the constraint can be found in lgap at the same index</span>
    <span class="n">lgapi</span> <span class="o">=</span> <span class="s1">&#39;lgapi&#39;</span>

    <span class="c1"># List where values correspond to the value of lower average constraints on an attribute, and</span>
    <span class="c1"># whose id can be found in lavri at the same index</span>
    <span class="n">lavr</span> <span class="o">=</span> <span class="s1">&#39;lavr&#39;</span>

    <span class="c1"># List where values values are attribute ids of attributes that have lower average constraints, and</span>
    <span class="c1"># where the value of the constraint can be found in lavr at the same index</span>
    <span class="n">lavri</span> <span class="o">=</span> <span class="s1">&#39;lavri&#39;</span>

    <span class="c1"># List where values correspond to the value of upper average constraints on an attribute, and</span>
    <span class="c1"># whose id can be found in uavri at the same index</span>
    <span class="n">uavr</span> <span class="o">=</span> <span class="s1">&#39;uavr&#39;</span>

    <span class="c1"># List where values values are attribute ids of attributes that have  upper average constraints, and</span>
    <span class="c1"># where the value of the constraint can be found in uavr at the same index</span>
    <span class="n">uavri</span> <span class="o">=</span> <span class="s1">&#39;uavri&#39;</span>

    <span class="c1"># List where values correspond to the value of lower span constraints on an attribute, and</span>
    <span class="c1"># whose id can be found in lspni at the same index</span>
    <span class="n">lspn</span> <span class="o">=</span> <span class="s1">&#39;lspn&#39;</span>

    <span class="c1"># List where values values are attribute ids of attributes that have  lower span constraints, and</span>
    <span class="c1"># where the value of the constraint can be found in lspn at the same index</span>
    <span class="n">lspni</span> <span class="o">=</span> <span class="s1">&#39;lspni&#39;</span>

    <span class="c1"># List where values correspond to the value of lower span constraints on an attribute, and</span>
    <span class="c1"># whose id can be found in uspni at the same index</span>
    <span class="n">uspn</span> <span class="o">=</span> <span class="s1">&#39;uspn&#39;</span>

    <span class="c1"># List where values values are attribute ids of attributes that have upper span constraints, and</span>
    <span class="c1"># where the value of the constraint can be found in uspn at the same index</span>
    <span class="n">uspni</span> <span class="o">=</span> <span class="s1">&#39;uspni&#39;</span>

    <span class="c1"># List where values correspond to the value of lower median constraints on an attribute, and</span>
    <span class="c1"># whose id can be found in lmedi at the same index</span>
    <span class="n">lmed</span> <span class="o">=</span> <span class="s1">&#39;lmed&#39;</span>

    <span class="c1"># List where values correspond to the value of upper median constraints on an attribute, and</span>
    <span class="c1"># whose id can be found in umedi at the same index</span>
    <span class="n">umed</span> <span class="o">=</span> <span class="s1">&#39;umed&#39;</span>

    <span class="c1"># List where values values are attribute ids of attributes that have  upper median constraints, and</span>
    <span class="c1"># where the value of the constraint can be found in umed at the same index</span>
    <span class="n">umedi</span> <span class="o">=</span> <span class="s1">&#39;umedi&#39;</span>

    <span class="c1"># List where values values are attribute ids of attributes that have  upper median constraints, and</span>
    <span class="c1"># where the value of the constraint can be found in lmed at the same index</span>
    <span class="n">lmedi</span> <span class="o">=</span> <span class="s1">&#39;lmedi&#39;</span>

    <span class="c1"># List where the indexes correspond to the attribute ids and values correspond to the number of</span>
    <span class="c1"># upper span constraints on that attribute</span>
    <span class="n">num_minmax</span> <span class="o">=</span> <span class="s1">&#39;num_minmax&#39;</span>

    <span class="c1"># List where the indexes correspond to the attribute ids and the values correspond to the number of</span>
    <span class="c1"># average constraints on that attribute</span>
    <span class="n">num_avr</span> <span class="o">=</span> <span class="s1">&#39;num_avr&#39;</span>

    <span class="c1"># List where the indexes correspond to the attribute ids and values correspond to the number of</span>
    <span class="c1"># median constraints on that attribute</span>
    <span class="n">num_med</span> <span class="o">=</span> <span class="s1">&#39;num_med&#39;</span>

    <span class="c1"># List where values are attribute ids of attribute that have gap constraints</span>
    <span class="n">tot_gap</span> <span class="o">=</span> <span class="s1">&#39;tot_gap&#39;</span>

    <span class="c1"># List where values are attribute ids of attribute that have span constraints</span>
    <span class="n">tot_spn</span> <span class="o">=</span> <span class="s1">&#39;tot_spn&#39;</span>

    <span class="c1"># List where values are attribute ids of attribute that have average constraints</span>
    <span class="n">tot_avr</span> <span class="o">=</span> <span class="s1">&#39;tot_avr&#39;</span>

    <span class="c1"># Number of attributes that constraint are enforced on</span>
    <span class="n">num_att</span> <span class="o">=</span> <span class="s1">&#39;num_att&#39;</span>

    <span class="c1"># List of sequences that will be mined for sequences</span>
    <span class="n">items</span> <span class="o">=</span> <span class="s1">&#39;items&#39;</span>

    <span class="c1"># List of attributes that constraints will be imposed on during mining</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="s1">&#39;attrs&#39;</span>

    <span class="c1"># Length of the largest sequence in items</span>
    <span class="n">M</span> <span class="o">=</span> <span class="s1">&#39;M&#39;</span>

    <span class="c1"># Number of sequences in items</span>
    <span class="n">N</span> <span class="o">=</span> <span class="s1">&#39;N&#39;</span>

    <span class="c1"># If integer sequences, the largest value, if string sequences the number of events</span>
    <span class="n">L</span> <span class="o">=</span> <span class="s1">&#39;L&#39;</span>

    <span class="c1"># List where index correspond to attribute ids and values to the maximum value for that attribute</span>
    <span class="n">max_attrs</span> <span class="o">=</span> <span class="s1">&#39;max_attrs&#39;</span>

    <span class="c1"># List where index correspond to the attribute ids and values to the minimum value for that attribute</span>
    <span class="n">min_attrs</span> <span class="o">=</span> <span class="s1">&#39;min_attrs&#39;</span>

    <span class="c1"># The data size threshold to dynamically decide if batch processing is needed to ease mining task</span>
    <span class="n">dynamic_batch_threshold</span> <span class="o">=</span> <span class="mi">500000</span>

    <span class="c1"># If batch_size is not set while the dataset has more than dynamic_batch_threshold sequences,</span>
    <span class="c1"># batch_size is set to be default_batch_size, to apply batch processing</span>
    <span class="n">default_batch_size</span> <span class="o">=</span> <span class="mi">10000</span>

    <span class="c1"># Default seed to define a random state</span>
    <span class="n">default_seed</span> <span class="o">=</span> <span class="mi">123456</span>


<div class="viewcode-block" id="Attribute"><a class="viewcode-back" href="../../api.html#sequential.seq2pat.Attribute">[docs]</a><span class="k">class</span> <span class="nc">Attribute</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">list</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attribute with given values.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        values: List[list]</span>
<span class="sd">            A list of lists corresponding to the values of each event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate input values</span>
        <span class="n">validate_attribute_values</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_values</span> <span class="o">=</span> <span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max</span> <span class="o">=</span> <span class="n">get_max_value</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_min</span> <span class="o">=</span> <span class="n">get_min_value</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Values</span>

<span class="sd">        The values of the attribute</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_values</span>

    <span class="k">def</span> <span class="nf">_set_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set values of attribute</span>

<span class="sd">        This function is used when Seq2Pat runs on batches of sequences. In each batch, the attributes and constraints</span>
<span class="sd">        need to be reset to be consistent to the sequences. Since the upper and lower bound are set on the entire set,</span>
<span class="sd">        it would be easier to copy the existing constraints but only reset the attribute values in a batch. It would be</span>
<span class="sd">        prevented to set values directly, thus we add the function to reset the attribute values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_values</span> <span class="o">=</span> <span class="n">values</span>

<div class="viewcode-block" id="Attribute.average"><a class="viewcode-back" href="../../api.html#sequential.seq2pat.Attribute.average">[docs]</a>    <span class="k">def</span> <span class="nf">average</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The Average Constraint</span>

<span class="sd">        Restricts the average value of a pattern.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_Constraint</span><span class="o">.</span><span class="n">Average</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Attribute.gap"><a class="viewcode-back" href="../../api.html#sequential.seq2pat.Attribute.gap">[docs]</a>    <span class="k">def</span> <span class="nf">gap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The Gap Constraint</span>

<span class="sd">        Restricts the difference between every two consecutive event values in a pattern.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_Constraint</span><span class="o">.</span><span class="n">Gap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Attribute.median"><a class="viewcode-back" href="../../api.html#sequential.seq2pat.Attribute.median">[docs]</a>    <span class="k">def</span> <span class="nf">median</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The Median Constraint</span>

<span class="sd">        Restricts the median value of a pattern.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_Constraint</span><span class="o">.</span><span class="n">Median</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Attribute.span"><a class="viewcode-back" href="../../api.html#sequential.seq2pat.Attribute.span">[docs]</a>    <span class="k">def</span> <span class="nf">span</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The Span Constraint</span>

<span class="sd">        Restricts the difference between the maximum and the minimum value in a pattern.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_Constraint</span><span class="o">.</span><span class="n">Span</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">_BaseConstraint</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">:</span> <span class="n">Attribute</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attribute</span> <span class="o">=</span> <span class="n">attribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lower_bound</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_upper_bound</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attribute</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lower_bound</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lower_bound</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">upper_bound</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upper_bound</span>

    <span class="k">def</span> <span class="nf">has_lower_bound</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">has_upper_bound</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_bound</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">check_satisfaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># Initialize returned results. When there are no constraints, result is explicitly set to be true.</span>
        <span class="n">res</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_upper_bound</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_bound</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_lower_bound</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_bound</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="fm">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_upper_bound</span> <span class="o">=</span> <span class="n">other</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lower_bound</span> <span class="o">=</span> <span class="n">other</span>
        <span class="k">return</span> <span class="bp">self</span>


<span class="k">class</span> <span class="nc">_Constraint</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Average</span><span class="p">(</span><span class="n">_BaseConstraint</span><span class="p">):</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">:</span> <span class="n">Attribute</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Gap</span><span class="p">(</span><span class="n">_BaseConstraint</span><span class="p">):</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">:</span> <span class="n">Attribute</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">check_satisfaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="c1"># Initialize returned results to be true.</span>
            <span class="n">res</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_upper_bound</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_bound</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_lower_bound</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_bound</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>

            <span class="k">return</span> <span class="n">res</span>

    <span class="k">class</span> <span class="nc">Median</span><span class="p">(</span><span class="n">_BaseConstraint</span><span class="p">):</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">:</span> <span class="n">Attribute</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Span</span><span class="p">(</span><span class="n">_BaseConstraint</span><span class="p">):</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">:</span> <span class="n">Attribute</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>


<div class="viewcode-block" id="Seq2Pat"><a class="viewcode-back" href="../../api.html#sequential.seq2pat.Seq2Pat">[docs]</a><span class="k">class</span> <span class="nc">Seq2Pat</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;**Seq2Pat: Sequence-to-Pattern Generation Library**</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    sequences: List[list]</span>
<span class="sd">        A list of sequences each with a list of events.</span>
<span class="sd">        The event values can be all strings or all integers.</span>
<span class="sd">    max_span: Optional[int]</span>
<span class="sd">        The value for applying a built-in maximum span constraint to the length of items in mining, max_span=10 by</span>
<span class="sd">        default (10 items). This is going to avoid regular users to run into a scaling issue when data contains long</span>
<span class="sd">        sequences but no constraints are used to run the mining efficiently and practically.</span>
<span class="sd">        Power users can choose to drop this constraint by setting it to be None or increase the maximum span</span>
<span class="sd">        as the system has resources to support.</span>
<span class="sd">    batch_size: Optional[int]</span>
<span class="sd">        The batch_size parameter is set to be None by default, then a mining task runs on the entire data set using a</span>
<span class="sd">        single thread. When batch_size is set, Seq2Pat runs on batches of sequences instead for improving scalability.</span>
<span class="sd">        Each batch contains `batch_size` sequences as a **random** sample of entire set. This is achieved by shuffling</span>
<span class="sd">        the entire set uniformly before we sequentially split the sequences into batches. A mining task will run on each</span>
<span class="sd">        batch with a reduced minimum row count (min_frequency) threshold. Please refer to description of discount_factor</span>
<span class="sd">        parameter for how min_frequency is reduced. Resulted patterns will be aggregated from the mining results of</span>
<span class="sd">        each batch by calculating the sum of the occurrences. Finally the original minimum row count threshold is</span>
<span class="sd">        applied to the patterns after aggregation. When batch_size is None but the dataset has more than</span>
<span class="sd">        _Constants.dynamic_batch_threshold sequences, batch_size is dynamically set to be _Constants.default_seed to</span>
<span class="sd">        ease the mining task on the large dataset by default. Power users can define specific batch_size,</span>
<span class="sd">        discount_factor and n_jobs for gaining more runtime benefit.</span>
<span class="sd">    discount_factor: float</span>
<span class="sd">        A discount factor is used to reduce the minimum row count (min_frequency) threshold when Seq2Pat is applied</span>
<span class="sd">        on a batch. The new threshold for a batch is defined to be max(min_frequency * discount_factor, 1.0/batch_size),</span>
<span class="sd">        where an integer min_frequency will be converted to a ratio first by min_frequency/number_total_sequences.</span>
<span class="sd">        Final results will be based on the aggregation of patterns from each batch by calculating the sum of the</span>
<span class="sd">        occurrences. Theoretically there is a chance that the batching results will be different from non-batching</span>
<span class="sd">        results. But a small discount_factor parameter will make the chance to be minimal and thus we have the same</span>
<span class="sd">        results as running on entire set in practices. A small value of discount_factor is thus recommended.</span>
<span class="sd">        discount_factor=0.2 by default.</span>
<span class="sd">    n_jobs: int</span>
<span class="sd">        n_jobs defines the number of processes (n_jobs=2 by default) that are used when mining tasks are applied</span>
<span class="sd">        on batches in parallel. If -1 all CPUs are used. If -2, all CPUs but one are used.</span>
<span class="sd">    seed: int</span>
<span class="sd">        Random seed to make sequences uniformly distributed among batches.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">        For power users who have interests to learn more about the designed batch processing behavior, an Experimental\</span>
<span class="sd">        Results Summary in the following would be useful.</span>

<span class="sd">        - We have experimental analysis for batch_size vs. discount_factor vs. runtime tested on a data set with \</span>
<span class="sd">        100k sequences.</span>

<span class="sd">        - The results show that when batch_size increases, e.g. from 10000 to 100000, we observe an increase in runtime,\</span>
<span class="sd">        while the mined patterns are all the same as mining on the entire set using single thread.</span>

<span class="sd">        - When batch_size=10000, we get the most runtime benefit compared to running on entire set.</span>

<span class="sd">        - On the same 100k sequences, we set batch_size=10000 and change discount_factor from 0.1 to 1.0. We observe\</span>
<span class="sd">        that the runtime decreases as discount_factor increases. Only when discount_factor=1.0, the batching mode will\</span>
<span class="sd">        miss some patterns compared to running on entire set. We would recommend discount_factor=0.2 by default for\</span>
<span class="sd">        the robustness in results, at the expenses of runtime.</span>

<span class="sd">        - In an even larger test on ~1M sequences, we set batch_size=10000, discount_factor=0.8, n_jobs=8.\</span>
<span class="sd">        Batch mode saves 60% of the runtime compared to running on entire set, while the resulted patterns from the\</span>
<span class="sd">        two processes are the same.</span>

<span class="sd">        - When data size is small, e.g., a few thousand sequences, there is no benefit to run batch mode.\</span>
<span class="sd">        Thus, we would recommend using the batch mode only when data has at least hundreds of thousands of sequences\</span>
<span class="sd">        for gaining the runtime benefit.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequences</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">list</span><span class="p">],</span> <span class="n">max_span</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                 <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">discount_factor</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">_Constants</span><span class="o">.</span><span class="n">default_seed</span><span class="p">):</span>
        <span class="c1"># Validate input</span>
        <span class="n">validate_sequences</span><span class="p">(</span><span class="n">sequences</span><span class="p">)</span>
        <span class="n">validate_max_span</span><span class="p">(</span><span class="n">max_span</span><span class="p">)</span>
        <span class="n">validate_batch_args</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">discount_factor</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>

        <span class="c1"># Input sequences</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequences</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequences</span>

        <span class="c1"># Sequences as strings or integers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_string</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sequences</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span>

        <span class="c1"># If string, internal mapping to between strings and integers</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_string</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_str_to_int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_int_to_str</span> <span class="o">=</span> <span class="n">item_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sequences</span> <span class="o">=</span> <span class="n">string_to_int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_str_to_int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="p">)</span>

        <span class="c1"># Set size variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_num_columns</span> <span class="o">=</span> <span class="n">get_max_column_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_value</span> <span class="o">=</span> <span class="n">get_max_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="p">)</span>

        <span class="c1"># Constraint store: attribute_id -&gt; constraint_name -&gt; Constraint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr_to_cts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Attribute</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Constraint</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># Cython implementor object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cython_imp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">max_span</span><span class="p">:</span>
            <span class="c1"># Create index attribute</span>
            <span class="n">index_attr</span> <span class="o">=</span> <span class="n">Attribute</span><span class="p">([[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">))]</span> <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">sequences</span><span class="p">])</span>

            <span class="c1"># Add built-in maximum span constraint on index.</span>
            <span class="c1"># The minimum span is at least 1 between two indices. Here we add it explicitly.</span>
            <span class="c1"># Given max_span items, the maximum difference on the index is (max_span - 1)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">index_attr</span><span class="o">.</span><span class="n">span</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">max_span</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Dynamically set batch_size to ease the mining task on a large dataset by default</span>
        <span class="c1"># If batch_size is None and num_rows &gt; dynamic_batch_threshold, set batch_size to apply batch processing</span>
        <span class="c1"># For dataset having num_rows &lt;= dynamic_batch_threshold, mining task runs on entire set if batch_size=None</span>
        <span class="c1"># Power users can define specific batch_size, discount_factor and n_jobs for gaining more runtime benefit</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">batch_size</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_rows</span> <span class="o">&gt;</span> <span class="n">_Constants</span><span class="o">.</span><span class="n">dynamic_batch_threshold</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">_Constants</span><span class="o">.</span><span class="n">default_batch_size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discount_factor</span> <span class="o">=</span> <span class="n">discount_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span> <span class="o">=</span> <span class="n">n_jobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>

        <span class="c1"># Set an internal rng object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sequences</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sequence</span>
<span class="sd">        The sequences of Seq2Pat.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequences</span>

<div class="viewcode-block" id="Seq2Pat.add_constraint"><a class="viewcode-back" href="../../api.html#sequential.seq2pat.Seq2Pat.add_constraint">[docs]</a>    <span class="k">def</span> <span class="nf">add_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraint</span><span class="p">:</span> <span class="n">_BaseConstraint</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_BaseConstraint</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds the given constraint to the constraint store.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        constraint: _BaseConstraint</span>
<span class="sd">            A constraint on an attribute object</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        The constraint handle.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError: If the constraint is already defined on this attribute.</span>
<span class="sd">        ValueError: If there is a mismatch in length of sequences and their attributes.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Attribute and constraint id</span>
        <span class="n">attr_id</span> <span class="o">=</span> <span class="n">constraint</span><span class="o">.</span><span class="n">attribute</span>
        <span class="n">ct_id</span> <span class="o">=</span> <span class="n">constraint</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="c1"># Create the attribute field, if not created already</span>
        <span class="k">if</span> <span class="n">attr_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_to_cts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">attr_to_cts</span><span class="p">[</span><span class="n">attr_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># If the same constraint type exists on this attribute already, raise error</span>
        <span class="k">if</span> <span class="n">ct_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_to_cts</span><span class="p">[</span><span class="n">attr_id</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">ct_id</span> <span class="o">+</span> <span class="s2">&quot; constraint is already defined on this attribute.&quot;</span><span class="p">)</span>

        <span class="c1"># Verify that attribute</span>
        <span class="n">check_true</span><span class="p">(</span><span class="n">check_sequence_feature_same_length</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="p">,</span> <span class="n">constraint</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
                   <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Each sequence should match given attributes in event length.&quot;</span><span class="p">))</span>

        <span class="c1"># Add the constraint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attr_to_cts</span><span class="p">[</span><span class="n">attr_id</span><span class="p">][</span><span class="n">ct_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">constraint</span>

        <span class="c1"># Return constraint handle (so that one can remove it)</span>
        <span class="k">return</span> <span class="n">constraint</span></div>

<div class="viewcode-block" id="Seq2Pat.remove_constraint"><a class="viewcode-back" href="../../api.html#sequential.seq2pat.Seq2Pat.remove_constraint">[docs]</a>    <span class="k">def</span> <span class="nf">remove_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraint</span><span class="p">:</span> <span class="n">_BaseConstraint</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Removes the given constraint from the constraint store.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        constraint: _BaseConstraint</span>
<span class="sd">            A constraint on an attribute object</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        KeyError: If the given constraint does not exist in the constraint store.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Attribute and constraint id</span>
        <span class="n">attribute_id</span> <span class="o">=</span> <span class="n">constraint</span><span class="o">.</span><span class="n">attribute</span>
        <span class="n">constraint_id</span> <span class="o">=</span> <span class="n">constraint</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Remove the constraint from the attribute</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_to_cts</span><span class="p">[</span><span class="n">attribute_id</span><span class="p">][</span><span class="n">constraint_id</span><span class="p">]</span>

            <span class="c1"># If no constraint left on the attribute, remove the attribute</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attr_to_cts</span><span class="p">[</span><span class="n">attribute_id</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_to_cts</span><span class="p">[</span><span class="n">attribute_id</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;No &quot;</span> <span class="o">+</span> <span class="n">constraint_id</span> <span class="o">+</span> <span class="s2">&quot; constraint to remove on this attribute.&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_run_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_frequency</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>

        <span class="c1"># Cython implementor object with input parameters set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cython_imp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cython_imp</span><span class="p">(</span><span class="n">min_frequency</span><span class="p">)</span>

        <span class="c1"># Frequent mining</span>
        <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cython_imp</span><span class="o">.</span><span class="n">mine</span><span class="p">())</span>

<div class="viewcode-block" id="Seq2Pat.get_patterns"><a class="viewcode-back" href="../../api.html#sequential.seq2pat.Seq2Pat.get_patterns">[docs]</a>    <span class="k">def</span> <span class="nf">get_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_frequency</span><span class="p">:</span> <span class="n">Num</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">list</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Performs the mining operation enforcing the constraints and returns the most frequent patterns.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        min_frequency: Num</span>
<span class="sd">           If int, represents the minimum number of sequences (rows) a pattern should occur.</span>
<span class="sd">           If float, should be (0.0, 1.0] and represents</span>
<span class="sd">           the minimum percentage of sequences (rows) a pattern should occur.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Each inner list represents a frequent pattern in the form\</span>
<span class="sd">        [event_1, event_2, event_3, ... event_n, frequency].\</span>
<span class="sd">        The last element is the frequency of the pattern.\</span>
<span class="sd">        Sequences are sored by decreasing frequency, i.e., most frequent pattern first.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check num_rows</span>
        <span class="n">check_true</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_rows</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Sequences should not be empty.&quot;</span><span class="p">))</span>

        <span class="c1"># Check min_frequency conditions</span>
        <span class="c1"># Given a set of `num_rows` sequences, we need to validate min_frequency.</span>
        <span class="c1"># In edge cases when min_frequency is not set properly, e.g. 0 or less than 1/num_rows, program will fail.</span>
        <span class="n">validate_min_frequency</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_rows</span><span class="p">,</span> <span class="n">min_frequency</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>

            <span class="c1"># Call Cython backend in a child process, write results to queue</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
            <span class="n">thread</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_thread</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">min_frequency</span><span class="p">,</span> <span class="n">q</span><span class="p">))</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="c1"># Get results from queue</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="c1"># Wait for process to finish and join the main process</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># When min_frequency is an integer, convert to float before it is applied to batches</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">min_frequency</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">min_frequency</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">min_frequency</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="p">)</span>

            <span class="n">patterns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_patterns_batch</span><span class="p">(</span><span class="n">min_frequency</span><span class="p">)</span>

        <span class="c1"># Map back to strings, if original is strings</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_string</span><span class="p">:</span>
            <span class="n">patterns</span> <span class="o">=</span> <span class="n">int_to_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_int_to_str</span><span class="p">,</span> <span class="n">patterns</span><span class="p">)</span>

        <span class="c1"># Sort sequences, most frequent pattern first</span>
        <span class="n">patterns_sorted</span> <span class="o">=</span> <span class="n">sort_pattern</span><span class="p">(</span><span class="n">patterns</span><span class="p">)</span>

        <span class="c1"># Clean up memory</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="c1"># Return frequent sequences</span>
        <span class="k">return</span> <span class="n">patterns_sorted</span></div>

    <span class="k">def</span> <span class="nf">_get_patterns_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_frequency</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">list</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get patterns from each batch with a relaxed min_frequency threshold, then aggregate pattern frequencies</span>
<span class="sd">        by using the summation of frequencies from batches.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        min_frequency: float</span>
<span class="sd">           Min_frequency should be a float in (0.0, 1.0] for batch processing.</span>
<span class="sd">           It represents the minimum percentage of sequences (rows) a pattern should occur.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List[list] where each inner list represents a frequent pattern in the form</span>
<span class="sd">        [event_1, event_2, event_3, ... event_n, frequency].</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Shuffle sequences uniformly to make each batch have similar pattern occurrences</span>
        <span class="n">sequences</span><span class="p">,</span> <span class="n">attr_to_cs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shuffle_data</span><span class="p">()</span>

        <span class="c1"># Get number of chunks</span>
        <span class="n">n_sequences</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sequences</span><span class="p">)</span>
        <span class="n">num_chunks</span> <span class="o">=</span> <span class="n">n_sequences</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="k">if</span> <span class="n">n_sequences</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">num_chunks</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Run Seq2Pat in parallel on each chunk, with a lower min_frequency threshold to get a larger set of patterns</span>
        <span class="n">batch_patterns</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">require</span><span class="o">=</span><span class="s1">&#39;sharedmem&#39;</span><span class="p">)(</span>
            <span class="n">delayed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mining_batch</span><span class="p">)(</span><span class="n">i</span><span class="p">,</span> <span class="n">sequences</span><span class="p">,</span> <span class="n">attr_to_cs</span><span class="p">,</span> <span class="n">min_frequency</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_chunks</span><span class="p">))</span>

        <span class="c1"># Aggregate patterns from each chunk over the counts and apply min_frequency threshold</span>
        <span class="n">min_row_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_sequences</span> <span class="o">*</span> <span class="n">min_frequency</span><span class="p">)</span>
        <span class="n">agg_patterns</span> <span class="o">=</span> <span class="n">aggregate_patterns</span><span class="p">(</span><span class="n">batch_patterns</span><span class="p">,</span> <span class="n">min_row_count</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">agg_patterns</span>

    <span class="k">def</span> <span class="nf">_shuffle_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Attribute</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Constraint</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shuffle sequences and attributes before running seq2pat on batches.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        shuffled_sequences: List[List]</span>
<span class="sd">            The shuffled sequences.</span>
<span class="sd">        shuffled_attr_to_cs: Dict[Attribute, Dict[str, _Constraint]]</span>
<span class="sd">            The shuffled constraints.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>

        <span class="n">shuffled_sequences</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
        <span class="n">shuffled_attr_to_cts</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attr_to_cts</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">shuffled_attr_to_cts</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cs</span> <span class="ow">in</span> <span class="n">shuffled_attr_to_cts</span><span class="p">[</span><span class="n">attr</span><span class="p">]:</span>
                <span class="n">old_constraint</span> <span class="o">=</span> <span class="n">shuffled_attr_to_cts</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="n">cs</span><span class="p">]</span>
                <span class="n">new_constraint</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">old_constraint</span><span class="p">)</span>
                <span class="n">shuffled_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">old_constraint</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>
                <span class="n">new_constraint</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">_set_values</span><span class="p">(</span><span class="n">shuffled_values</span><span class="p">)</span>
                <span class="n">shuffled_attr_to_cts</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="n">cs</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_constraint</span>

        <span class="k">return</span> <span class="n">shuffled_sequences</span><span class="p">,</span> <span class="n">shuffled_attr_to_cts</span>

    <span class="k">def</span> <span class="nf">_mining_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk_ind</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">sequences</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">],</span> <span class="n">attr_to_cs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Attribute</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Constraint</span><span class="p">]],</span>
                      <span class="n">min_frequency</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Implementor of pattern mining on each batch</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        chunk_ind: int</span>
<span class="sd">           chunk index</span>
<span class="sd">        sequences: List[list]</span>
<span class="sd">           A list of sequences each with a list of events.</span>
<span class="sd">           The event values can be all strings or all integers.</span>
<span class="sd">        attr_to_cs: Dict[Attribute, Dict[str, _Constraint]]</span>
<span class="sd">        min_frequency: float</span>
<span class="sd">           Min_frequency should be a float in (0.0, 1.0] for batch processing</span>
<span class="sd">           It represents the minimum percentage of sequences (rows) a pattern should occur.</span>

<span class="sd">        Returns:</span>
<span class="sd">        -------</span>
<span class="sd">        List[list] where each inner list represents a frequent pattern in the form</span>
<span class="sd">        [event_1, event_2, event_3, ... event_n, frequency].</span>
<span class="sd">        The last element is the frequency of the pattern.</span>
<span class="sd">        Sequences are sored by decreasing frequency, i.e., most frequent pattern first.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get one batch of sequences</span>
        <span class="n">batch_sequences</span> <span class="o">=</span> <span class="n">sequences</span><span class="p">[</span><span class="n">chunk_ind</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:(</span><span class="n">chunk_ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">]</span>

        <span class="c1"># Create seq2pat instance for one batch</span>
        <span class="n">batch_seq2pat</span> <span class="o">=</span> <span class="n">Seq2Pat</span><span class="p">(</span><span class="n">batch_sequences</span><span class="p">,</span> <span class="n">max_span</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Create constraints for one batch</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attr_to_cs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cs</span> <span class="ow">in</span> <span class="n">attr_to_cs</span><span class="p">[</span><span class="n">attr</span><span class="p">]:</span>
                <span class="n">old_constraint</span> <span class="o">=</span> <span class="n">attr_to_cs</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="n">cs</span><span class="p">]</span>
                <span class="n">new_constraint</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">old_constraint</span><span class="p">)</span>
                <span class="n">new_constraint</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">_set_values</span><span class="p">(</span><span class="n">old_constraint</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">chunk_ind</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>
                                                                                    <span class="p">(</span><span class="n">chunk_ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">])</span>
                <span class="n">batch_seq2pat</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">new_constraint</span><span class="p">)</span>

        <span class="c1"># Reduce min_frequency to be min_frequency * discount_factor, 0 &lt; discount_factor &lt; 1</span>
        <span class="n">adjusted_min_frequency</span> <span class="o">=</span> <span class="n">update_min_frequency</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_sequences</span><span class="p">),</span> <span class="n">min_frequency</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">discount_factor</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">batch_seq2pat</span><span class="o">.</span><span class="n">get_patterns</span><span class="p">(</span><span class="n">adjusted_min_frequency</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_cython_imp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_frequency</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">stp</span><span class="o">.</span><span class="n">PySeq2pat</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates and populates a Cython PySeq2Pat object based on the user inputs</span>
<span class="sd">        by translating sequential attribute into their appropriate PySeq2Pat</span>
<span class="sd">        representation and setting them.</span>
<span class="sd">        :param min_frequency: the minimum number of sequences(rows) to observe the pattern</span>
<span class="sd">        :return: PySeq2Pat object with all the necessary inputs set</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cython_imp</span> <span class="o">=</span> <span class="n">stp</span><span class="o">.</span><span class="n">PySeq2pat</span><span class="p">()</span>

        <span class="c1"># Dictionary to hold all parameters that need to be set in seq_to_pat more information about what each</span>
        <span class="c1"># parameter represents can be found under Constants declaration</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">_Constants</span><span class="o">.</span><span class="n">lgap</span><span class="p">:</span> <span class="p">[],</span> <span class="n">_Constants</span><span class="o">.</span><span class="n">ugap</span><span class="p">:</span> <span class="p">[],</span> <span class="n">_Constants</span><span class="o">.</span><span class="n">lavr</span><span class="p">:</span> <span class="p">[],</span> <span class="n">_Constants</span><span class="o">.</span><span class="n">uavr</span><span class="p">:</span> <span class="p">[],</span>
                  <span class="n">_Constants</span><span class="o">.</span><span class="n">lspn</span><span class="p">:</span> <span class="p">[],</span>
                  <span class="n">_Constants</span><span class="o">.</span><span class="n">uspn</span><span class="p">:</span> <span class="p">[],</span> <span class="n">_Constants</span><span class="o">.</span><span class="n">lmed</span><span class="p">:</span> <span class="p">[],</span> <span class="n">_Constants</span><span class="o">.</span><span class="n">umed</span><span class="p">:</span> <span class="p">[],</span> <span class="n">_Constants</span><span class="o">.</span><span class="n">ugapi</span><span class="p">:</span> <span class="p">[],</span>
                  <span class="n">_Constants</span><span class="o">.</span><span class="n">lgapi</span><span class="p">:</span> <span class="p">[],</span>
                  <span class="n">_Constants</span><span class="o">.</span><span class="n">uspni</span><span class="p">:</span> <span class="p">[],</span> <span class="n">_Constants</span><span class="o">.</span><span class="n">lspni</span><span class="p">:</span> <span class="p">[],</span> <span class="n">_Constants</span><span class="o">.</span><span class="n">uavri</span><span class="p">:</span> <span class="p">[],</span> <span class="n">_Constants</span><span class="o">.</span><span class="n">lavri</span><span class="p">:</span> <span class="p">[],</span>
                  <span class="n">_Constants</span><span class="o">.</span><span class="n">umedi</span><span class="p">:</span> <span class="p">[],</span> <span class="n">_Constants</span><span class="o">.</span><span class="n">lmedi</span><span class="p">:</span> <span class="p">[],</span> <span class="n">_Constants</span><span class="o">.</span><span class="n">num_minmax</span><span class="p">:</span> <span class="p">[],</span> <span class="n">_Constants</span><span class="o">.</span><span class="n">num_avr</span><span class="p">:</span> <span class="p">[],</span>
                  <span class="n">_Constants</span><span class="o">.</span><span class="n">num_med</span><span class="p">:</span> <span class="p">[],</span> <span class="n">_Constants</span><span class="o">.</span><span class="n">tot_gap</span><span class="p">:</span> <span class="p">[],</span> <span class="n">_Constants</span><span class="o">.</span><span class="n">tot_spn</span><span class="p">:</span> <span class="p">[],</span> <span class="n">_Constants</span><span class="o">.</span><span class="n">tot_avr</span><span class="p">:</span> <span class="p">[],</span>
                  <span class="n">_Constants</span><span class="o">.</span><span class="n">num_att</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_Constants</span><span class="o">.</span><span class="n">items</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequences</span><span class="p">,</span> <span class="n">_Constants</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span> <span class="p">[],</span>
                  <span class="n">_Constants</span><span class="o">.</span><span class="n">M</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_num_columns</span><span class="p">,</span> <span class="n">_Constants</span><span class="o">.</span><span class="n">N</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_rows</span><span class="p">,</span> <span class="n">_Constants</span><span class="o">.</span><span class="n">L</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_value</span><span class="p">,</span>
                  <span class="n">_Constants</span><span class="o">.</span><span class="n">max_attrs</span><span class="p">:</span> <span class="p">[],</span> <span class="n">_Constants</span><span class="o">.</span><span class="n">min_attrs</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="c1"># Iterate through all attributes and constraint and build parameters required by seq_to_pat</span>
        <span class="k">for</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">constraints</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_to_cts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">num_att</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">num_minmax</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">num_avr</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">num_med</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">max_attrs</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attribute</span><span class="o">.</span><span class="n">_max</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">min_attrs</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attribute</span><span class="o">.</span><span class="n">_min</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">attrs</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attribute</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">constraint_type</span><span class="p">,</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">constraint</span><span class="p">,</span> <span class="n">_Constraint</span><span class="o">.</span><span class="n">Average</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_average_params</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">constraint</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">constraint</span><span class="p">,</span> <span class="n">_Constraint</span><span class="o">.</span><span class="n">Gap</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_gap_params</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">constraint</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">constraint</span><span class="p">,</span> <span class="n">_Constraint</span><span class="o">.</span><span class="n">Median</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_median_params</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">constraint</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">constraint</span><span class="p">,</span> <span class="n">_Constraint</span><span class="o">.</span><span class="n">Span</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_span_params</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">constraint</span><span class="p">)</span>

        <span class="c1"># Given all the parameters, setup the c++ object through the intermediary cython seq_to_pat.pyx</span>
        <span class="k">for</span> <span class="n">constraint</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># print(constraint, &quot; &quot;, value)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cython_imp</span><span class="p">,</span> <span class="n">constraint</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># Set frequency as a row count or row percentage. 1.0 will be used as percentage.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">min_frequency</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">min_frequency</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">cython_imp</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="n">cython_imp</span><span class="o">.</span><span class="n">N</span> <span class="o">*</span> <span class="n">min_frequency</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cython_imp</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="n">min_frequency</span>

        <span class="k">return</span> <span class="n">cython_imp</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_update_average_params</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">constraint</span><span class="p">:</span> <span class="n">_Constraint</span><span class="o">.</span><span class="n">Average</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates average constraint inputs for C++ backend</span>
<span class="sd">        :param constraint: average constraint obj</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># attribute id for attribute that a constraint will be enforced on</span>
        <span class="n">att_id</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">num_att</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">tot_avr</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">constraint</span><span class="o">.</span><span class="n">has_lower_bound</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">lavr</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constraint</span><span class="o">.</span><span class="n">lower_bound</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">lavri</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att_id</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">num_avr</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">constraint</span><span class="o">.</span><span class="n">has_upper_bound</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">uavr</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constraint</span><span class="o">.</span><span class="n">upper_bound</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">uavri</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att_id</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">num_avr</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_update_gap_params</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">constraint</span><span class="p">:</span> <span class="n">_Constraint</span><span class="o">.</span><span class="n">Gap</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update gap constraint inputs for C++ backend</span>
<span class="sd">        :param constraint: gap constraint obj</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># attribute id for attribute that a constraint will be enforced on</span>
        <span class="n">att_id</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">num_att</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">tot_gap</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">constraint</span><span class="o">.</span><span class="n">has_lower_bound</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">lgap</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constraint</span><span class="o">.</span><span class="n">lower_bound</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">lgapi</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">constraint</span><span class="o">.</span><span class="n">has_upper_bound</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">ugap</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constraint</span><span class="o">.</span><span class="n">upper_bound</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">ugapi</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att_id</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_update_median_params</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">constraint</span><span class="p">:</span> <span class="n">_Constraint</span><span class="o">.</span><span class="n">Median</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates median constraint inputs for C++ backend</span>
<span class="sd">        :param constraint: median constraint obj</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># attribute id for attribute that a constraint will be enforced on</span>
        <span class="n">att_id</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">num_att</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">constraint</span><span class="o">.</span><span class="n">has_lower_bound</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">lmed</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constraint</span><span class="o">.</span><span class="n">lower_bound</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">lmedi</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att_id</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">num_med</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">constraint</span><span class="o">.</span><span class="n">has_upper_bound</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">umed</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constraint</span><span class="o">.</span><span class="n">upper_bound</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">umedi</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att_id</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">num_med</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_update_span_params</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">constraint</span><span class="p">:</span> <span class="n">_Constraint</span><span class="o">.</span><span class="n">Span</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates span constraint inputs for C++ backend</span>
<span class="sd">        :param constraint: span constraint obj</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;attribute id for attribute that a constraint will be enforced on, we want att_id to start from zero but are </span>
<span class="sd">        using the number of attribute so we simply start from one.&quot;&quot;&quot;</span>
        <span class="n">att_id</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">num_att</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">tot_spn</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">constraint</span><span class="o">.</span><span class="n">has_lower_bound</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">lspn</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constraint</span><span class="o">.</span><span class="n">lower_bound</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">lspni</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att_id</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">num_minmax</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span>

        <span class="k">if</span> <span class="n">constraint</span><span class="o">.</span><span class="n">has_upper_bound</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">uspn</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constraint</span><span class="o">.</span><span class="n">upper_bound</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="n">_Constants</span><span class="o">.</span><span class="n">uspni</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">att_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;return human-readable string representation of the class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Seq2Pat&quot;</span>
        <span class="k">for</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">constraints</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_to_cts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">str</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Constraints of Attribute: &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
            <span class="nb">str</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Constraints: &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">constraint_type</span><span class="p">,</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">str</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Constraint: &quot;</span> <span class="o">+</span> <span class="n">constraint_type</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span>
                <span class="nb">str</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">LB: &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">constraint</span><span class="o">.</span><span class="n">lower_bound</span><span class="p">)</span>
                <span class="nb">str</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">UB: &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">constraint</span><span class="o">.</span><span class="n">upper_bound</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">str</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright GPL 2.0.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>